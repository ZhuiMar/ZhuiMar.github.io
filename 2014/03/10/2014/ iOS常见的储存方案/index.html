<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><title>iOS常见的储存方案 - zhuimar</title><meta name="description" content="首先要明确区分两个概念，数据结构和储存方式。所谓数据结构就是数据存在的形式。除了基本的 NSDictionary、NSArray 和 NSSet 这些对象，还有更复杂的如：关系模型、对象图和属性列表多种结构。"><link type="text/css" rel="stylesheet" href="/css/pure.css?v=0.0.1"><link type="text/css" rel="stylesheet" href="/css/style.css?v=0.0.1"><script type="text/javascript" src="//cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script></head></html><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS常见的储存方案</h1><a id="logo" href="/.">zhuimar</a></div><div id="nav-menu"><div class="bitcron_nav"><div class="site_nav_wrap"><div class="site_nav"><span class="a_container"><a href="/." class="selected active current">首页</a></span><span class="a_container"><a href="/archives/">归档</a></span><span class="a_container"><a href="/about/">关于</a></span><span class="a_container"><a href="/atom.xml">订阅</a></span></div></div></div></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS常见的储存方案</h1><div class="post-meta">2014-03-10<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" type="text/javascript"></script><span class="meta-space">  |  </span><span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span><span> 浏览</span></span></div><!--文章内容--><div class="post-content"><h3 id="iOS四种常见的储存方案"><a href="#iOS四种常见的储存方案" class="headerlink" title="iOS四种常见的储存方案"></a>iOS四种常见的储存方案</h3><ul>
<li><p>概念问题<br>首先要明确区分两个概念，数据结构和储存方式。所谓数据结构就是数据存在的形式。除了基本的<code>NSDictionary</code>、<code>NSArray</code>和<code>NSSet</code>这些对象，还有更复杂的如：关系模型、对象图和属性列表多种结构。而存储方式则简单的分为两种：内存与闪存。内存存储是临时的，运行时有效的，但效率高，而闪存则是一种持久化存储，但产生I/O消耗，效率相对低。把内存数据转移到闪存中进行持久化的操作称成为归档。二者结合起来才是完整的数据存储方案，我们最常谈起的那些：SQLite、CoreData、NSUserDefaults等都是数据存储方案。当然在这些框架提供的方案之外，我们自己也可以按照个性化需求订制方案。这些存储方案侧重不同，支持的形式和方式也各不相同，在不同的使用场景下表现也是各有优劣。但万变不离其宗。</p>
</li>
<li><p>以下将对四种存储方式进行详细的介绍</p>
</li>
<li>NSUserDefaults，用于存储配置信息</li>
<li>SQLite，用于存储查询需求较多的数据</li>
<li>CoreData，用于规划应用中的对象</li>
<li><p>使用基本对象类型定制的个性化缓存方案</p>
<p>用NSUserDefaults存储配置信息<br>NSUserDefaults被设计用来存储设备和应用的配置信息，它通过一个工厂方法返回默认的、也是最常用到的实例对象。这个对象中储存了系统中用户的配置信息，开发者可以通过这个实例对象对这些已有的信息进行修改，也可以按照自己的需求创建新的配置项。<br>NSUserDefaults把配置信息以字典的形式组织起来，支持字典的项包括：字符串或者是数组，除此之外还支持数字等基本格式。一句话概括就是：基础类型的小数据的字典。操作方法几乎与NSDictionary的操作方法无异，另外还可以通过指定返回类型的方法获取到指定类型的返回值。<br>NSUserDefaults的所有数据都放在内存里，因此操作速度很快，并还提供一个归档方法：+ (void)synchronize。开发者自定义的配置项（如图2中的最后一项 key:alkdjfkladsjfmm）会以plist格式的文件归档在相应应用目录的/Library/Preferences/[App_Bundle_Identifier].plist文件。再次初始化获得实例对象后，框架会把用户自定义的这个配置和系统配置合并得到完整数据。</p>
<p>用SQLite存储查询需求较多的数据<br>iOS的SDK里预置了SQLite的库，开发者可以自建SQLite数据库。SQLite每次写入数据都会产生IO消耗，把数据归档到相应的文件。SQLite擅长处理的数据类型其实与NSUserDefaults差不多，也是基础类型的小数据，只是从组织形式上不同。开发者可以以关系型数据库的方式组织数据，使用SQL DML来管理数据。 一般来说应用中的格式化的文本类数据可以存放在数据库中，尤其是类似聊天记录、Timeline等这些具有条件查询和排序需求的数据。每一个数据库的句柄都会在内存中都会被分配一段缓存，用于提高查询效率。另一个方面，由于查询缓存，当产生大量句柄或数据量较大时，会出现缓存过大，造成内存浪费。SQLite的使用起来要比NSUserDefaults复杂的多，因此建议开发者使用SQLite要搭配一个操作控件使用，可以简化操作。笔者开发的SQLight是一款对SQLite操作的封装，把相对复杂的SQLite命令封装成对象和方法，可以供大家参考。大家可以在Github上获取这个工程的代码进一步了解。</p>
<p>用CoreData规划应用中对象<br>官方给出的定义是，一个支持持久化的，对象图和生命周期的自动化管理方案。严格意义上说CoreData是一个管理方案，他的持久化可以通过SQLite、XML或二进制文件储存。如官方定义所说，CoreData的作用远远不止储存数据这么简单，它可以把整个应用中的对象建模并进行自动化的管理。<br>MyDocument是一个对象实例，有两个Collection：Employee和Department，存放各自的对象列表。MyDocument、Employee和Department三个对象以及他们之间的关系都通过CoreData建模，并可以通过save方法进行持久化。<br>从归档文件还原模型时CoreData并不是一次性把整个模型中的所有数据都载入内存，而是根据运行时状态，把被调用到的对象实例载入内存。框架会自动控制这个过程，从而达到控制内存消耗，避免浪费。<br>无论从设计原理还是使用方法上看，CoreData都比较复杂。因此，如果仅仅是考虑缓存数据这个需求，CoreData绝对不是一个优选方案。CoreData的使用场景在于：整个应用使用CoreData规划，把应用内的数据通过CoreData建模，完全基于CoreData架构应用。<br>之前提到的NSUserDefaults和SQLite适合存储基础类型的小数据，而CoreData则不适合存储单一的数据</p>
</li>
</ul>
<h3 id="iOS四种储存方案的使用"><a href="#iOS四种储存方案的使用" class="headerlink" title="iOS四种储存方案的使用"></a>iOS四种储存方案的使用</h3><p> 保存文件的额目录</p>
<ul>
<li>持久化<br>所谓的持久化，就是将数据保存到硬盘中，使得在应用程序或机器重启后可以继续访问之前保存的数据。</li>
<li>沙盒<br>在介绍各种存储方法之前，有必要说明以下沙盒机制。iOS程序默认情况下只能访问程序自己的目录，这个目录被称为“沙盒”。</li>
</ul>
<p>沙盒的目录结构</p>
<ul>
<li>Documents</li>
<li>Library</li>
<li>Caches</li>
<li>Preferences</li>
<li><p>tmp</p>
<p>目录特性<br>虽然沙盒中有这么多文件夹，但是没有文件夹都不尽相同，都有各自的特性。所以在选择存放目录时，一定要认真选择适合的目录。</p>
<p>应用程序包</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这里面存放的是应用程序的源文件，包括资源文件和可执行文件。</span></div><div class="line"><span class="built_in">NSString</span> *path = [[<span class="built_in">NSBundle</span> mainBundle] bundlePath];</div></pre></td></tr></table></figure>
<p>Documents</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//最常用的目录，iTunes同步该应用时会同步此文件夹中的内容，适合存储重要数据。</span></div><div class="line"><span class="built_in">NSString</span> *path = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, path);</div></pre></td></tr></table></figure>
<p>Library/Caches</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//iTunes不会同步此文件夹，适合存储体积大，不需要备份的非重要数据。</span></div><div class="line"><span class="built_in">NSString</span> *path = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, path);</div></pre></td></tr></table></figure>
<p>Library/Preferences<br>iTunes同步该应用时会同步此文件夹中的内容，通常保存应用的设置信息。</p>
<p>tmp<br>iTunes不会同步此文件夹，系统可能在应用没运行时就删除该目录下的文件，所以此目录适合保存应用中的一些临时文件，用完就删除。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = <span class="built_in">NSTemporaryDirectory</span>();</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, path);</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="plist文件"><a href="#plist文件" class="headerlink" title="plist文件"></a>plist文件</h3><p>plist文件是将某些特定的类，通过XML文件的方式保存在目录中，可以被序列化的类型只有如下几种：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span>;</div><div class="line"><span class="built_in">NSMutableArray</span>;</div><div class="line"><span class="built_in">NSDictionary</span>;</div><div class="line"><span class="built_in">NSMutableDictionary</span>;</div><div class="line"><span class="built_in">NSData</span>;</div><div class="line"><span class="built_in">NSMutableData</span>;</div><div class="line"><span class="built_in">NSString</span>;</div><div class="line"><span class="built_in">NSMutableString</span>;</div><div class="line"><span class="built_in">NSNumber</span>;</div><div class="line"><span class="built_in">NSDate</span>;</div></pre></td></tr></table></figure></p>
<p>1.获得文件路径<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject;</div><div class="line"><span class="built_in">NSString</span> *fileName = [path stringByAppendingPathComponent:<span class="string">@"123.plist"</span>];</div></pre></td></tr></table></figure></p>
<p>2.存储<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span> *array = @[<span class="string">@"123"</span>, <span class="string">@"456"</span>, <span class="string">@"789"</span>];</div><div class="line">[array writeToFile:fileName atomically:<span class="literal">YES</span>];</div></pre></td></tr></table></figure></p>
<p>3.读取<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSArray</span> *result = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:fileName];</div></pre></td></tr></table></figure></p>
<p> 4.注意<br>只有以上列出的类型才能使用plist文件存储。存储时使用writeToFile: atomically:方法。 其中atomically表示是否需要先写入一个辅助文件，再把辅助文件拷贝到目标文件地址。这是更安全的写入文件方法，一般都写YES。读取时使用arrayWithContentsOfFile:方法。</p>
<p> Preference<br>1.使用方法</p>
<ul>
<li><p>获得NSUserDefaults文件</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSUserDefaults</span> *userDefaults = [<span class="built_in">NSUserDefaults</span> standardUserDefaults];</div></pre></td></tr></table></figure>
</li>
<li><p>向文件中写入内容</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[userDefaults setObject:<span class="string">@"AAA"</span> forKey:<span class="string">@"a"</span>];</div><div class="line">[userDefaults setBool:<span class="literal">YES</span> forKey:<span class="string">@"sex"</span>];</div><div class="line">[userDefaults setInteger:<span class="number">21</span> forKey:<span class="string">@"age"</span>];</div></pre></td></tr></table></figure>
</li>
<li><p>立即同步</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[userDefaults synchronize];</div></pre></td></tr></table></figure>
</li>
<li><p>读取文件</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *name = [userDefaults objectForKey:<span class="string">@"a"</span>];</div><div class="line"><span class="built_in">BOOL</span> sex = [userDefaults boolForKey:<span class="string">@"sex"</span>];</div><div class="line"><span class="built_in">NSInteger</span> age = [userDefaults integerForKey:<span class="string">@"age"</span>];</div></pre></td></tr></table></figure>
<p>2.注意<br>偏好设置是专门用来保存应用程序的配置信息的，一般不要在偏好设置中保存其他数据。如果没有调用synchronize方法，系统会根据I/O情况不定时刻地保存到文件中。所以如果需要立即写入文件的就必须调用synchronize方法。偏好设置会将所有数据保存到同一个文件中。即preference目录下的一个以此应用包名来命名的plist文件。</p>
</li>
<li>NSKeyedArchiver<br>归档在iOS中是另一种形式的序列化，只要遵循了NSCoding协议的对象都可以通过它实现序列化。由于决大多数支持存储数据的Foundation和Cocoa Touch类都遵循了NSCoding协议，因此，对于大多数类来说，归档相对而言还是比较容易实现的。</li>
<li>遵循NSCoding协议<br>NSCoding协议声明了两个方法，这两个方法都是必须实现的。一个用来说明如何将对象编码到归档中，另一个说明如何进行解档来获取一个新对象。</li>
<li><p>遵循协议和设置属性</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1.遵循NSCoding协议 </span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCoding</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//2.设置属性</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIImage</span> *avatar;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> age;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
</li>
<li><p>实现协议方法<br>解档</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</div><div class="line">    <span class="keyword">if</span> ([<span class="keyword">super</span> init]) &#123;</div><div class="line">        <span class="keyword">self</span>.avatar = [aDecoder decodeObjectForKey:<span class="string">@"avatar"</span>];</div><div class="line">        <span class="keyword">self</span>.name = [aDecoder decodeObjectForKey:<span class="string">@"name"</span>];</div><div class="line">        <span class="keyword">self</span>.age = [aDecoder decodeIntegerForKey:<span class="string">@"age"</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>归档<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder &#123;</div><div class="line">    [aCoder encodeObject:<span class="keyword">self</span>.avatar forKey:<span class="string">@"avatar"</span>];</div><div class="line">    [aCoder encodeObject:<span class="keyword">self</span>.name forKey:<span class="string">@"name"</span>];</div><div class="line">    [aCoder encodeInteger:<span class="keyword">self</span>.age forKey:<span class="string">@"age"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>特别注意</code>如果需要归档的类是某个自定义类的子类时，就需要在归档和解档之前先实现父类的归档和解档方法。即 [super encodeWithCoder:aCoder] 和 [super initWithCoder:aDecoder] 方法;<br>2.使用<br>需要把对象归档是调用NSKeyedArchiver的工厂方法 archiveRootObject: toFile: 方法。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *file = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject stringByAppendingPathComponent:<span class="string">@"person.data"</span>];</div><div class="line">Person *person = [[Person alloc] init];</div><div class="line">person.avatar = <span class="keyword">self</span>.avatarView.image;</div><div class="line">person.name = <span class="keyword">self</span>.nameField.text;</div><div class="line">person.age = [<span class="keyword">self</span>.ageField.text integerValue];</div><div class="line">[<span class="built_in">NSKeyedArchiver</span> archiveRootObject:person toFile:file];</div></pre></td></tr></table></figure></p>
<p>需要从文件中解档对象就调用NSKeyedUnarchiver的一个工厂方法unarchiveObjectWithFile: 即可<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *file = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject stringByAppendingPathComponent:<span class="string">@"person.data"</span>];</div><div class="line">Person *person = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:file];</div><div class="line"><span class="keyword">if</span> (person) &#123;</div><div class="line">    <span class="keyword">self</span>.avatarView.image = person.avatar;</div><div class="line">    <span class="keyword">self</span>.nameField.text = person.name;</div><div class="line">    <span class="keyword">self</span>.ageField.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>, person.age];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.注意<br>1.必须遵循并实现NSCoding协议<br>2.保存文件的扩展名可以任意指定<br>3.继承时必须先调用父类的归档解档方法</p>
<h2 id="SQLite3"><a href="#SQLite3" class="headerlink" title="SQLite3"></a>SQLite3</h2><p>之前的所有存储方法，都是覆盖存储。如果想要增加一条数据就必须把整个文件读出来，然后修改数据后再把整个内容覆盖写入文件。所以它们都不适合存储大量的内容。</p>
<ol>
<li>字段类型<br>表面上SQLite将数据分为以下几种类型：</li>
</ol>
<ul>
<li>integer : 整数</li>
<li>real : 实数（浮点数）</li>
<li>text : 文本字符串</li>
<li>blob : 二进制数据，比如文件，图片之类的<br>实际上SQLite是无类型的。即不管你在创表时指定的字段类型是什么，存储是依然可以存储任意类型的数据。而且在创表时也可以不指定字段类型。SQLite之所以什么类型就是为了良好的编程规范和方便开发人员交流，所以平时在使用时最好设置正确的字段类型！主键必须设置成integer</li>
</ul>
<p>2.准备工作<br>准备工作就是导入依赖库啦，在iOS中要使用SQLite3，需要添加库文件：libsqlite3.dylib并导入主头文件，这是一个C语言的库，所以直接使用SQLite3还是比较麻烦的。</p>
<p>3.使用,创建数据库并打开<br>操作数据库之前必须先指定数据库文件和要操作的表，所以使用SQLite3，首先要打开数据库文件，然后指定或创建一张表。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">*  打开数据库并创建一个表</div><div class="line">*/</div><div class="line">- (<span class="keyword">void</span>)openDatabase &#123;</div><div class="line">    <span class="comment">//1.设置文件名</span></div><div class="line">    <span class="built_in">NSString</span> *filename = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject stringByAppendingPathComponent:<span class="string">@"person.db"</span>];</div><div class="line">    <span class="comment">//2.打开数据库文件，如果没有会自动创建一个文件</span></div><div class="line">    <span class="built_in">NSInteger</span> result = sqlite3_open(filename.UTF8String, &amp;_sqlite3);</div><div class="line">    <span class="keyword">if</span> (result == SQLITE_OK) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"打开数据库成功！"</span>);</div><div class="line">        <span class="comment">//3.创建一个数据库表</span></div><div class="line">        <span class="keyword">char</span> *errmsg = <span class="literal">NULL</span>;</div><div class="line">        sqlite3_exec(_sqlite3, <span class="string">"CREATE TABLE IF NOT EXISTS t_person(id integer primary key autoincrement, name text, age integer)"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;errmsg);</div><div class="line">        <span class="keyword">if</span> (errmsg) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"错误：%s"</span>, errmsg);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"创表成功！"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"打开数据库失败！"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>4.执行指令<br>使用 sqlite3_exec() 方法可以执行任何SQL语句，比如创表、更新、插入和删除操作。但是一般不用它执行查询语句，因为它不会返回查询到的数据。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">*  往表中插入1000条数据</div><div class="line">*/</div><div class="line">- (<span class="keyword">void</span>)insertData &#123;</div><div class="line">    <span class="built_in">NSString</span> *nameStr;</div><div class="line">    <span class="built_in">NSInteger</span> age;</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</div><div class="line">        nameStr = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Bourne-%d"</span>, arc4random_uniform(<span class="number">10000</span>)];</div><div class="line">        age = arc4random_uniform(<span class="number">80</span>) + <span class="number">20</span>;</div><div class="line">        <span class="built_in">NSString</span> *sql = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"INSERT INTO t_person (name, age) VALUES('%@', '%ld')"</span>, nameStr, age];</div><div class="line">        <span class="keyword">char</span> *errmsg = <span class="literal">NULL</span>;</div><div class="line">        sqlite3_exec(_sqlite3, sql.UTF8String, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;errmsg);</div><div class="line">        <span class="keyword">if</span> (errmsg) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"错误：%s"</span>, errmsg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"插入完毕！"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>查询指令<br>前面说过一般不使用 sqlite3_exec() 方法查询数据。因为查询数据必须要获得查询结果，所以查询相对比较麻烦。示例代码如下：</li>
</ol>
<ul>
<li>sqlite3_prepare_v2() : 检查sql的合法性</li>
<li>sqlite3_step() : 逐行获取查询结果，不断重复，直到最后一条记录</li>
<li>sqlite3_coloum_xxx() : 获取对应类型的内容，iCol对应的就是SQL语句中字段的顺序，从0开始。根据实际查询字段的属性，使用sqlite3_column_xxx取得对应的内容即可。</li>
<li>sqlite3_finalize() : 释放stmt<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">*  从表中读取数据到数组中</div><div class="line">*/</div><div class="line">- (<span class="keyword">void</span>)readData &#123;</div><div class="line">    <span class="built_in">NSMutableArray</span> *mArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="number">1000</span>];</div><div class="line">    <span class="keyword">char</span> *sql = <span class="string">"select name, age from t_person;"</span>;</div><div class="line">    sqlite3_stmt *stmt;</div><div class="line">    <span class="built_in">NSInteger</span> result = sqlite3_prepare_v2(_sqlite3, sql, <span class="number">-1</span>, &amp;stmt, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">if</span> (result == SQLITE_OK) &#123;</div><div class="line">        <span class="keyword">while</span> (sqlite3_step(stmt) == SQLITE_ROW) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">char</span> *name = (<span class="keyword">char</span> *)sqlite3_column_text(stmt, <span class="number">0</span>);</div><div class="line">            <span class="built_in">NSInteger</span> age = sqlite3_column_int(stmt, <span class="number">1</span>);</div><div class="line"></div><div class="line">            <span class="comment">//创建对象</span></div><div class="line">            Person *person = [Person personWithName:[<span class="built_in">NSString</span> stringWithUTF8String:name] Age:age];</div><div class="line">            [mArray addObject:person];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">self</span>.dataList = mArray;</div><div class="line">    &#125;</div><div class="line">    sqlite3_finalize(stmt);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>总得来说，SQLite3的使用还是比较麻烦的，因为都是些c语言的函数，理解起来有些困难。不过在一般开发过程中，使用的都是第三方开源库 FMDB，封装了这些基本的c语言方法，使得我们在使用时更加容易理解，提高开发效率。</p>
<h2 id="FMDB"><a href="#FMDB" class="headerlink" title="FMDB"></a>FMDB</h2><p>1.简介<br>FMDB是iOS平台的SQLite数据库框架，它是以OC的方式封装了SQLite的C语言API，它相对于cocoa自带的C语言框架有如下的优点:</p>
<ul>
<li>使用起来更加面向对象，省去了很多麻烦、冗余的C语言代码</li>
<li>对比苹果自带的Core Data框架，更加轻量级和灵活</li>
<li>提供了多线程安全的数据库操作方法，有效地防止数据混乱</li>
</ul>
<p>2.核心类<br>FMDB有三个主要的类:</p>
<ul>
<li><p>FMDatabase<br>一个FMDatabase对象就代表一个单独的SQLite数据库，用来执行SQL语句</p>
</li>
<li><p>FMResultSet<br>使用FMDatabase执行查询后的结果集</p>
</li>
<li><p>FMDatabaseQueue<br>用于在多线程中执行多个查询或更新，它是线程安全的</p>
<p>3.打开数据库<br>和c语言框架一样，FMDB通过指定SQLite数据库文件路径来创建FMDatabase对象，但FMDB更加容易理解，使用起来更容易，使用之前一样需要导入sqlite3.dylib。打开数据库方法如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).firstObject stringByAppendingPathComponent:<span class="string">@"person.db"</span>];</div><div class="line">FMDatabase *database = [FMDatabase databaseWithPath:path];    </div><div class="line"><span class="keyword">if</span> (![database open]) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"数据库打开失败！"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>值得注意的是，Path的值可以传入以下三种情况：</p>
<ul>
<li>具体文件路径，如果不存在会自动创建</li>
<li>空字符串@””，会在临时目录创建一个空的数据库，当FMDatabase连接关闭时，数据库文件也被删除</li>
<li>nil，会创建一个内存中临时数据库，当FMDatabase连接关闭时，数据库会被销毁<br>4.更新<br>在FMDB中，除查询以外的所有操作，都称为“更新”, 如：create、drop、insert、update、delete等操作，使用executeUpdate:方法执行更新：<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//常用方法有以下3种：   </span></div><div class="line">- (<span class="built_in">BOOL</span>)executeUpdate:(<span class="built_in">NSString</span>*)sql, ...</div><div class="line">- (<span class="built_in">BOOL</span>)executeUpdateWithFormat:(<span class="built_in">NSString</span>*)format, ...</div><div class="line">- (<span class="built_in">BOOL</span>)executeUpdate:(<span class="built_in">NSString</span>*)sql withArgumentsInArray:(<span class="built_in">NSArray</span> *)arguments</div><div class="line"><span class="comment">//示例</span></div><div class="line">[database executeUpdate:<span class="string">@"CREATE TABLE IF NOT EXISTS t_person(id integer primary key autoincrement, name text, age integer)"</span>];   </div><div class="line"><span class="comment">//或者  </span></div><div class="line">[database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES(?, ?)"</span>, <span class="string">@"Bourne"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">42</span>]];</div></pre></td></tr></table></figure>
</li>
</ul>
<p>5.查询<br>查询方法也有3种，使用起来相当简单：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (FMResultSet *)executeQuery:(<span class="built_in">NSString</span>*)sql, ...</div><div class="line">- (FMResultSet *)executeQueryWithFormat:(<span class="built_in">NSString</span>*)format, ...</div><div class="line">- (FMResultSet *)executeQuery:(<span class="built_in">NSString</span> *)sql withArgumentsInArray:(<span class="built_in">NSArray</span> *)arguments</div></pre></td></tr></table></figure></p>
<p>查询示例<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1.执行查询</span></div><div class="line">FMResultSet *result = [database executeQuery:<span class="string">@"SELECT * FROM t_person"</span>];</div><div class="line"><span class="comment">//2.遍历结果集</span></div><div class="line"><span class="keyword">while</span> ([result next]) &#123;</div><div class="line">    <span class="built_in">NSString</span> *name = [result stringForColumn:<span class="string">@"name"</span>];</div><div class="line">    <span class="keyword">int</span> age = [result intForColumn:<span class="string">@"age"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>6.线程安全<br>在多个线程中同时使用一个FMDatabase实例是不明智的。不要让多个线程分享同一个FMDatabase实例，它无法在多个线程中同时使用。 如果在多个线程中同时使用一个FMDatabase实例，会造成数据混乱等问题。所以，请使用 FMDatabaseQueue，它是线程安全的。以下是使用方法：</p>
<p>创建队列<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FMDatabaseQueue *queue = [FMDatabaseQueue databaseQueueWithPath:aPath];</div></pre></td></tr></table></figure></p>
<p>使用队列<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[queue inDatabase:^(FMDatabase *database) &#123;    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_1"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">1</span>]];    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_2"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">2</span>]];    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_3"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">3</span>]];      </div><div class="line">    FMResultSet *result = [database executeQuery:<span class="string">@"select * from t_person"</span>];    </div><div class="line">    <span class="keyword">while</span>([result next]) &#123;   </div><div class="line"></div><div class="line">    &#125;    </div><div class="line">&#125;];</div><div class="line"><span class="comment">//而且可以轻松地把简单任务包装到事务里：</span></div><div class="line">[queue inTransaction:^(FMDatabase *database, <span class="built_in">BOOL</span> *rollback) &#123;    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_1"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">1</span>]];    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_2"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">2</span>]];    </div><div class="line">    [database executeUpdate:<span class="string">@"INSERT INTO t_person(name, age) VALUES (?, ?)"</span>, <span class="string">@"Bourne_3"</span>, [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">3</span>]];      </div><div class="line">    FMResultSet *result = [database executeQuery:<span class="string">@"select * from t_person"</span>];    </div><div class="line">    <span class="keyword">while</span>([result next]) &#123;   </div><div class="line">    &#125;   </div><div class="line">    <span class="comment">// 回滚</span></div><div class="line">    *rollback = <span class="literal">YES</span>;  </div><div class="line">&#125;];</div></pre></td></tr></table></figure></p>
<p>FMDatabaseQueue 后台会建立系列化的G-C-D队列，并执行你传给G-C-D队列的块。这意味着 你从多线程同时调用调用方法，GDC也会按它接收的块的顺序来执行。</p>
<h2 id="CoreData的基本使用"><a href="#CoreData的基本使用" class="headerlink" title="CoreData的基本使用"></a>CoreData的基本使用</h2><p>准备工作</p>
<ul>
<li>创建数据库<br>新建文件，选择CoreData -&gt; DataModel，添加实体（表）Add Entity，给表中添加属性，点击Attributes下方的‘+’号</li>
<li>创建模型文件<br>新建文件，选择CoreData -&gt; NSManaged Object subclass，根据提示，选择实体</li>
<li>通过代码，关联数据库和实体<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">/*</span></div><div class="line">    * 关联的时候，如果本地没有数据库文件，Ｃoreadata自己会创建</div><div class="line">    */</div><div class="line">    <span class="comment">// 1. 上下文</span></div><div class="line">    <span class="built_in">NSManagedObjectContext</span> *context = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</div><div class="line">    <span class="comment">// 2. 上下文关连数据库</span></div><div class="line">    <span class="comment">// 2.1 model模型文件</span></div><div class="line">    <span class="built_in">NSManagedObjectModel</span> *model = [<span class="built_in">NSManagedObjectModel</span> mergedModelFromBundles:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.2 持久化存储调度器</span></div><div class="line">    <span class="comment">// 持久化，把数据保存到一个文件，而不是内存</span></div><div class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *store = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:model];</div><div class="line"></div><div class="line">    <span class="comment">// 2.3 设置CoreData数据库的名字和路径</span></div><div class="line">    <span class="built_in">NSString</span> *doc = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</div><div class="line">    <span class="built_in">NSString</span> *sqlitePath = [doc stringByAppendingPathComponent:<span class="string">@"company.sqlite"</span>];</div><div class="line">    [store addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:[<span class="built_in">NSURL</span> fileURLWithPath:sqlitePath] options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</div><div class="line">    context.persistentStoreCoordinator = store;</div><div class="line">    _context = context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>CoreData的基本操作（CURD）<br>添加元素 - Create<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)addEmployee&#123;</div><div class="line">    <span class="comment">// 创建一个员工对象 </span></div><div class="line">    <span class="comment">//Employee *emp = [[Employee alloc] init]; 不能用此方法创建</span></div><div class="line">    Employee *emp = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Employee"</span> inManagedObjectContext:_context];</div><div class="line">    emp.name = <span class="string">@"wangwu"</span>;</div><div class="line">    emp.height = @<span class="number">1.80</span>;</div><div class="line">    emp.birthday = [<span class="built_in">NSDate</span> date];</div><div class="line"></div><div class="line">    <span class="comment">// 直接保存数据库</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    [_context save:&amp;error];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读取数据 - Read<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)readEmployee&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 1.FetchRequest 获取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.设置过滤条件</span></div><div class="line">    <span class="comment">// 查找zhangsan</span></div><div class="line">    <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"name = %@"</span>,</div><div class="line">    <span class="string">@"zhangsan"</span>];</div><div class="line">    request.predicate = pre;</div><div class="line"></div><div class="line">    <span class="comment">// 3.设置排序</span></div><div class="line">    <span class="comment">// 身高的升序排序</span></div><div class="line">    <span class="built_in">NSSortDescriptor</span> *heigtSort = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"height"</span> ascending:<span class="literal">NO</span>];</div><div class="line">    request.sortDescriptors = @[heigtSort];</div><div class="line"></div><div class="line">    <span class="comment">// 4.执行请求</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:&amp;error];</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//NSLog(@"%@",emps);</span></div><div class="line"></div><div class="line">    <span class="comment">//遍历员工</span></div><div class="line">    <span class="keyword">for</span> (Employee *emp <span class="keyword">in</span> emps) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"名字 %@ 身高 %@ 生日 %@"</span>,emp.name,emp.height,emp.birthday);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改数据 - Update<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)updateEmployee&#123;</div><div class="line">    <span class="comment">// 改变zhangsan的身高为2m</span></div><div class="line"></div><div class="line">    <span class="comment">// 1.查找到zhangsan</span></div><div class="line">    <span class="comment">// 1.1FectchRequest 抓取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 1.2设置过滤条件</span></div><div class="line">    <span class="comment">// 查找zhangsan</span></div><div class="line">    <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"name = %@"</span>, <span class="string">@"zhangsan"</span>];</div><div class="line">    request.predicate = pre;</div><div class="line"></div><div class="line">    <span class="comment">// 1.3执行请求</span></div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.更新身高</span></div><div class="line">    <span class="keyword">for</span> (Employee *e <span class="keyword">in</span> emps) &#123;</div><div class="line">        e.height = @<span class="number">2.0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 3.保存</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    [_context save:&amp;error];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>删除数据 - Delete<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)deleteEmployee&#123;</div><div class="line">    <span class="comment">// 删除 lisi</span></div><div class="line">    <span class="comment">// 1.查找lisi</span></div><div class="line">    <span class="comment">// 1.1FectchRequest 抓取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 1.2设置过滤条件</span></div><div class="line">    <span class="comment">// 查找zhangsan</span></div><div class="line">    <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"name = %@"</span>,</div><div class="line">    <span class="string">@"lisi"</span>];</div><div class="line">    request.predicate = pre;</div><div class="line"></div><div class="line">    <span class="comment">// 1.3执行请求</span></div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.删除</span></div><div class="line">    <span class="keyword">for</span> (Employee *e <span class="keyword">in</span> emps) &#123;</div><div class="line">    [_context deleteObject:e];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 3.保存</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    [_context save:&amp;error];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>CoreData的表关联<br>准备工作</p>
<ul>
<li>创建数据库<br>新建文件，选择CoreData -&gt; DataModel，添加实体（表），Add Entity ， 注意：这里根据关联添加多个实体，给表中添加属性，点击Attributes下方的‘+’号</li>
<li>创建模型文件<br>新建文件，选择CoreData -&gt; NSManaged Object subclass， 根据提示，选择实体，注意：这里先选择被关联的实体，最后添加最上层的实体,  通过代码，关联数据库和实体<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">/*</span></div><div class="line">    * 关联的时候，如果本地没有数据库文件，Ｃoreadata自己会创建</div><div class="line">    */</div><div class="line">    <span class="comment">// 1. 上下文</span></div><div class="line">    <span class="built_in">NSManagedObjectContext</span> *context = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</div><div class="line"></div><div class="line">    <span class="comment">// 2. 上下文关连数据库</span></div><div class="line"></div><div class="line">    <span class="comment">// 2.1 model模型文件</span></div><div class="line">    <span class="built_in">NSManagedObjectModel</span> *model = [<span class="built_in">NSManagedObjectModel</span> mergedModelFromBundles:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.2 持久化存储调度器</span></div><div class="line">    <span class="comment">// 持久化，把数据保存到一个文件，而不是内存</span></div><div class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *store = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:model];</div><div class="line"></div><div class="line">    <span class="comment">// 2.3 设置CoreData数据库的名字和路径</span></div><div class="line">    <span class="built_in">NSString</span> *doc = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</div><div class="line">    <span class="built_in">NSString</span> *sqlitePath = [doc stringByAppendingPathComponent:<span class="string">@"company.sqlite"</span>];</div><div class="line">    </div><div class="line">    [store addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:[<span class="built_in">NSURL</span> fileURLWithPath:sqlitePath] options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</div><div class="line">    context.persistentStoreCoordinator = store;</div><div class="line">    _context = context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>基本操作<br>添加元素 - Create<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)addEmployee&#123;</div><div class="line">    <span class="comment">// 1. 创建两个部门 ios android</span></div><div class="line">    <span class="comment">//1.1 iOS部门</span></div><div class="line">    Department *iosDepart = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Department"</span> inManagedObjectContext:_context];</div><div class="line">    iosDepart.name = <span class="string">@"ios"</span>;</div><div class="line">    iosDepart.departNo = <span class="string">@"0001"</span>;</div><div class="line">    iosDepart.createDate = [<span class="built_in">NSDate</span> date];</div><div class="line"></div><div class="line">    <span class="comment">//1.2 Android部门</span></div><div class="line">    Department *andrDepart = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Department"</span> inManagedObjectContext:_context];</div><div class="line">    andrDepart.name = <span class="string">@"android"</span>;</div><div class="line">    andrDepart.departNo = <span class="string">@"0002"</span>;</div><div class="line">    andrDepart.createDate = [<span class="built_in">NSDate</span> date];</div><div class="line"></div><div class="line">    <span class="comment">//2. 创建两个员工对象 zhangsan属于ios部门 lisi属于android部门</span></div><div class="line">    <span class="comment">//2.1 zhangsan</span></div><div class="line">    Employee *zhangsan = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Employee"</span> inManagedObjectContext:_context];</div><div class="line">    zhangsan.name = <span class="string">@"zhangsan"</span>;</div><div class="line">    zhangsan.height = @(<span class="number">1.90</span>);</div><div class="line">    zhangsan.birthday = [<span class="built_in">NSDate</span> date];</div><div class="line">    zhangsan.depart = iosDepart;</div><div class="line"></div><div class="line">    <span class="comment">//2.2 lisi</span></div><div class="line">    Employee *lisi = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Employee"</span> inManagedObjectContext:_context];</div><div class="line">    lisi.name = <span class="string">@"lisi"</span>;</div><div class="line">    lisi.height = @<span class="number">2.0</span>;</div><div class="line">    lisi.birthday = [<span class="built_in">NSDate</span> date];</div><div class="line">    lisi.depart = andrDepart;</div><div class="line"></div><div class="line">    <span class="comment">//3. 保存数据库</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    [_context save:&amp;error];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,error);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读取信息 - read<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)readEmployee&#123;</div><div class="line">    <span class="comment">// 读取ios部门的员工</span></div><div class="line">    <span class="comment">// 1.FectchRequest 抓取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.设置过滤条件</span></div><div class="line">    <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"depart.name = %@"</span>,<span class="string">@"android"</span>];</div><div class="line">    request.predicate = pre;</div><div class="line"></div><div class="line">    <span class="comment">// 4.执行请求</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:&amp;error];</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//遍历员工</span></div><div class="line">    <span class="keyword">for</span> (Employee *emp <span class="keyword">in</span> emps) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"名字 %@ 部门 %@"</span>,emp.name,emp.depart.name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>CoreData的模糊查询<br>模糊查询<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)readEmployee&#123;</div><div class="line">    <span class="comment">// 1.FectchRequest 抓取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2.设置排序</span></div><div class="line">    <span class="comment">// 按照身高的升序排序</span></div><div class="line">    <span class="built_in">NSSortDescriptor</span> *heigtSort = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"height"</span> ascending:<span class="literal">NO</span>];</div><div class="line">    request.sortDescriptors = @[heigtSort];</div><div class="line"></div><div class="line">    <span class="comment">// 3.模糊查询</span></div><div class="line">    <span class="comment">// 3.1 名字以"wang"开头</span></div><div class="line">    <span class="comment">//    NSPredicate *pre = [NSPredicate predicateWithFormat:@"name BEGINSWITH %@",@"wangwu1"];</span></div><div class="line">    <span class="comment">//    request.predicate = pre;</span></div><div class="line"></div><div class="line">    <span class="comment">// 名字以"1"结尾</span></div><div class="line">    <span class="comment">//    NSPredicate *pre = [NSPredicate predicateWithFormat:@"name ENDSWITH %@",@"1"];</span></div><div class="line">    <span class="comment">//    request.predicate = pre;</span></div><div class="line"></div><div class="line">    <span class="comment">// 名字包含"wu1"</span></div><div class="line">    <span class="comment">//    NSPredicate *pre = [NSPredicate predicateWithFormat:@"name CONTAINS %@",@"wu1"];</span></div><div class="line">    <span class="comment">//    request.predicate = pre;</span></div><div class="line"></div><div class="line">    <span class="comment">// like 匹配</span></div><div class="line">    <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"name like %@"</span>,<span class="string">@"*wu12"</span>];</div><div class="line">    request.predicate = pre;</div><div class="line"></div><div class="line">    <span class="comment">// 4.执行请求</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:&amp;error];</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//遍历员工</span></div><div class="line">    <span class="keyword">for</span> (Employee *emp <span class="keyword">in</span> emps) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"名字 %@ 身高 %@ 生日 %@"</span>,emp.name,emp.height,emp.birthday);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>分页查询<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)pageSeacher&#123;</div><div class="line">    <span class="comment">// 1. FectchRequest 抓取请求对象</span></div><div class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Employee"</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2. 设置排序</span></div><div class="line">    <span class="comment">// 身高的升序排序</span></div><div class="line">    <span class="built_in">NSSortDescriptor</span> *heigtSort = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"height"</span> ascending:<span class="literal">NO</span>];</div><div class="line">    request.sortDescriptors = @[heigtSort];</div><div class="line"></div><div class="line">    <span class="comment">// 3. 分页查询</span></div><div class="line">    <span class="comment">// 总有共有15数据</span></div><div class="line">    <span class="comment">// 每次获取6条数据</span></div><div class="line">    <span class="comment">// 第一页 0,6</span></div><div class="line">    <span class="comment">// 第二页 6,6</span></div><div class="line">    <span class="comment">// 第三页 12,6 3条数据</span></div><div class="line"></div><div class="line">    <span class="comment">// 3.1 分页的起始索引</span></div><div class="line">    request.fetchOffset = <span class="number">12</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 3.2 分页的条数</span></div><div class="line">    request.fetchLimit = <span class="number">6</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 4. 执行请求</span></div><div class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSArray</span> *emps = [_context executeFetchRequest:request error:&amp;error];</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 5. 遍历员工</span></div><div class="line">    <span class="keyword">for</span> (Employee *emp <span class="keyword">in</span> emps) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"名字 %@ 身高 %@ 生日 %@"</span>,emp.name,emp.height,emp.birthday);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>多个数据库的使用<br>创建多个数据库，即创建多个DataModel,一个数据库对应一个上下文,需要根据bundle名创建上下文。添加或读取信息，需要根据不同的上下文，访问不同的实体。</p>
<p>关联数据库和实体<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">// 一个数据库对应一个上下文</span></div><div class="line">    _companyContext = [<span class="keyword">self</span> setupContextWithModelName:<span class="string">@"Company"</span>];</div><div class="line">    _weiboContext = [<span class="keyword">self</span> setupContextWithModelName:<span class="string">@"Weibo"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">*  根据模型文件，返回一个上下文</div><div class="line">*/</div><div class="line">-(<span class="built_in">NSManagedObjectContext</span> *)setupContextWithModelName:(<span class="built_in">NSString</span> *)modelName&#123;</div><div class="line">    <span class="comment">// 1. 上下文</span></div><div class="line">    <span class="built_in">NSManagedObjectContext</span> *context = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</div><div class="line"></div><div class="line">    <span class="comment">// 2. 上下文关连数据库</span></div><div class="line">    <span class="comment">// 2.1 model模型文件</span></div><div class="line"></div><div class="line">    <span class="comment">// 注意：如果使用下面的方法，如果 bundles为nil 会把bundles里面的所有模型文件的表放在一个数据库</span></div><div class="line">    <span class="comment">//NSManagedObjectModel *model = [NSManagedObjectModel mergedModelFromBundles:nil];</span></div><div class="line"></div><div class="line">    <span class="comment">// 改为以下的方法获取：</span></div><div class="line">    <span class="built_in">NSURL</span> *companyURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:modelName withExtension:<span class="string">@"momd"</span>];</div><div class="line">    <span class="built_in">NSManagedObjectModel</span> *model = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:companyURL];</div><div class="line"></div><div class="line">    <span class="comment">// 2.2 持久化存储调度器</span></div><div class="line">    <span class="comment">// 持久化，把数据保存到一个文件，而不是内存</span></div><div class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *store = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:model];</div><div class="line"></div><div class="line">    <span class="comment">// 2.3 告诉Coredata数据库的名字和路径</span></div><div class="line">    <span class="built_in">NSString</span> *doc = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</div><div class="line">    <span class="built_in">NSString</span> *sqliteName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@.sqlite"</span>,modelName];</div><div class="line">    <span class="built_in">NSString</span> *sqlitePath = [doc stringByAppendingPathComponent:sqliteName];</div><div class="line"></div><div class="line">    [store addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:[<span class="built_in">NSURL</span> fileURLWithPath:sqlitePath] options:<span class="literal">nil</span> error:<span class="literal">nil</span>];</div><div class="line">    context.persistentStoreCoordinator = store;</div><div class="line"></div><div class="line">    <span class="comment">// 3. 返回上下文</span></div><div class="line">    <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加元素<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">IBAction</span>)addEmployee&#123;</div><div class="line">    <span class="comment">// 1. 添加员工</span></div><div class="line">    Employee *emp = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Employee"</span> inManagedObjectContext:_companyContext];</div><div class="line">    emp.name = <span class="string">@"zhagsan"</span>;</div><div class="line">    emp.height = @<span class="number">2.3</span>;</div><div class="line">    emp.birthday = [<span class="built_in">NSDate</span> date];</div><div class="line"></div><div class="line">    <span class="comment">// 直接保存数据库</span></div><div class="line">    [_companyContext save:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">    <span class="comment">// 2. 发微博</span></div><div class="line">    Status *status =[<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Status"</span> inManagedObjectContext:_weiboContext];</div><div class="line">    status.text = <span class="string">@"发了一条微博！"</span>;</div><div class="line">    status.createDate = [<span class="built_in">NSDate</span> date];</div><div class="line">    [_weiboContext save:<span class="literal">nil</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><!--文章标签--><div class="tags"></div><!--评论--><div id="disqus_thread"><script>var disqus_shortname = 'zhuimar';
var disqus_identifier = '2014/03/10/2014/ iOS常见的储存方案/';
var disqus_title = 'iOS常见的储存方案';
var disqus_url = 'http://yoursite.com/2014/03/10/2014/ iOS常见的储存方案/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><!--script(id='dsq-count-scr', src='//#{theme.disqus}.disqus.com/count.js', async)--></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" id="search" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"> 分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">19</span></li></ul></div><div class="widget"><div class="widget-title"> 标签</div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"> 最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2014/07/23/2014/指定View倒角位置/">指定View倒角位置</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/07/15/2014/iOS控制器生命周期/">iOS控制器生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/07/07/2014/iOS UITableView优化/">iOS UITableView优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/06/11/2014/iOS中ReactiveCocoa的使用/">iOS中ReactiveCocoa的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/06/11/2014/iOS运行时Runtime/">iOS运行时Runtime</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/06/09/2014/IOS知名大牛博客/">iOS知名大牛博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/06/03/2014/iOS精度丢失的处理/">iOS精度丢失的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/05/29/2014/iOS常用的三种枚举/">iOS常用的三种种枚举</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/05/21/2014/iOS编程词汇大全/">iOS编程词汇大全</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/05/17/2014/iOS字符串的强弱引用的区别/">iOS字符串的强弱引用的区别</a></li></ul></div><div class="widget"><div class="widget-title"> 友情链接</div><ul class="links-list"><li class="links-list-item"><a href="http://blog.csdn.net/leixiaohua1020" title="雷霄骅" target="_blank">雷霄骅</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="http://blog.devtang.com/" title="唐巧" target="_blank">唐巧</a></li></ul><ul class="links-list"><li class="links-list-item"><a href="http://casatwy.com" title="田伟宇" target="_blank">田伟宇</a></li></ul></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">zhuimar.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> Theme<a target="_blank" href="https://github.com/7ye/maupassant-hexo"> Maupassant.</a></div><a id="back_to_top" href="javascript:void(0)" class="back_to_top"><span>△</span></a><script type="text/javascript" src="/js/totop.js?v=0.0.1"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>function auto_code_fit(){
  if($(".highlight").length != 0){
    var pc_width = $(".post-content").width();
    $(".highlight .code").find("pre").width((pc_width-70)+"px");
  }
}
window.onresize = function(){
  auto_code_fit();
}
auto_code_fit();</script></div></body>