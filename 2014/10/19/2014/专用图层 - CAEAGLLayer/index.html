<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><title>专用图层 - CAEAGLLayer - zhuimar</title><link type="text/css" rel="stylesheet" href="/css/pure.css?v=0.0.1"><link type="text/css" rel="stylesheet" href="/css/style.css?v=0.0.1"><script type="text/javascript" src="//cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script></head></html><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">专用图层 - CAEAGLLayer</h1><a id="logo" href="/.">zhuimar</a></div><div id="nav-menu"><div class="bitcron_nav"><div class="site_nav_wrap"><div class="site_nav"><span class="a_container"><a href="/." class="selected active current">首页</a></span><span class="a_container"><a href="/archives/">归档</a></span><span class="a_container"><a href="/about/">关于</a></span><span class="a_container"><a href="/blog/">博客</a></span><span class="a_container"><a href="/music/">音乐</a></span><span class="a_container"><a href="/video/">视频</a></span><span class="a_container"><a href="/atom.xml">订阅</a></span></div></div></div></div></div><div id="layout" class="pure-g"><div class="pure-u-1"><div class="content_container"><div class="post"><h1 class="post-title">专用图层 - CAEAGLLayer</h1><div class="post-content"><p>当iOS要处理高性能图形绘制，必要时就是OpenGL。应该说它应该是最后的杀手锏，至少对于非游戏的应用来说是的。因为相比Core Animation和UIkit框架，它不可思议地复杂。</p>
<p>OpenGL提供了Core Animation的基础，它是底层的C接口，直接和iPhone，iPad的硬件通信，极少地抽象出来的方法。OpenGL没有对象或是图层的继承概念。它只是简单地处理三角形。OpenGL中所有东西都是3D空间中有颜色和纹理的三角形。用起来非常复杂和强大，但是用OpenGL绘制iOS用户界面就需要很多很多的工作了。</p>
<p>为了能够以高性能使用Core Animation，你需要判断你需要绘制哪种内容（矢量图形，例子，文本，等等），但后选择合适的图层去呈现这些内容，Core Animation中只有一些类型的内容是被高度优化的；所以如果你想绘制的东西并不能找到标准的图层类，想要得到高性能就比较费事情了。</p>
<p>因为OpenGL根本不会对你的内容进行假设，它能够绘制得相当快。利用OpenGL，你可以绘制任何你知道必要的集合信息和形状逻辑的内容。所以很多游戏都喜欢用OpenGL（这些情况下，Core Animation的限制就明显了：它优化过的内容类型并不一定能满足需求），但是这样依赖，方便的高度抽象接口就没了。</p>
<p>在iOS 5中，苹果引入了一个新的框架叫做GLKit，它去掉了一些设置OpenGL的复杂性，提供了一个叫做CLKView的UIView的子类，帮你处理大部分的设置和绘制工作。前提是各种各样的OpenGL绘图缓冲的底层可配置项仍然需要你用CAEAGLLayer完成，它是CALayer的一个子类，用来显示任意的OpenGL图形。</p>
<p>大部分情况下你都不需要手动设置CAEAGLLayer（假设用GLKView），过去的日子就不要再提了。特别的，我们将设置一个OpenGL ES 2.0的上下文，它是现代的iOS设备的标准做法。</p>
<p>尽管不需要GLKit也可以做到这一切，但是GLKit囊括了很多额外的工作，比如设置顶点和片段着色器，这些都以类C语言叫做GLSL自包含在程序中，同时在运行时载入到图形硬件中。编写GLSL代码和设置EAGLayer没有什么关系，所以我们将用GLKBaseEffect类将着色逻辑抽象出来。其他的事情，我们还是会有以往的方式。</p>
<p>在开始之前，你需要将GLKit和OpenGLES框架加入到你的项目中，里面是设置一个GAEAGLLayer的最少工作，它使用了OpenGL ES 2.0 的绘图上下文，并渲染了一个有色三角。</p>
<p>用<font color="#DC143C">CAEAGLLayer</font>绘制一个三角形</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></div><div class="line"><span class="meta">#import</span></div><div class="line"><span class="meta">#import</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIView</span> *glView;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) EAGLContext *glContext;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CAEAGLLayer</span> *glLayer;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) GLuint framebuffer;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) GLuint colorRenderbuffer;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) GLint framebufferWidth;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) GLint framebufferHeight;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) GLKBaseEffect *effect;</div><div class="line">￼</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setUpBuffers&#123;</div><div class="line">    <span class="comment">//set up frame buffer</span></div><div class="line">    glGenFramebuffers(<span class="number">1</span>, &amp;_framebuffer);</div><div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, _framebuffer);</div><div class="line"></div><div class="line">    <span class="comment">//set up color render buffer</span></div><div class="line">    glGenRenderbuffers(<span class="number">1</span>, &amp;_colorRenderbuffer);</div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, _colorRenderbuffer);</div><div class="line">    glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_RENDERBUFFER, _colorRenderbuffer);</div><div class="line">    [<span class="keyword">self</span>.glContext renderbufferStorage:GL_RENDERBUFFER fromDrawable:<span class="keyword">self</span>.glLayer];</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_WIDTH, &amp;_framebufferWidth);</div><div class="line">    glGetRenderbufferParameteriv(GL_RENDERBUFFER, GL_RENDERBUFFER_HEIGHT, &amp;_framebufferHeight);</div><div class="line"></div><div class="line">    <span class="comment">//check success</span></div><div class="line">    <span class="keyword">if</span> (glCheckFramebufferStatus(GL_FRAMEBUFFER) != GL_FRAMEBUFFER_COMPLETE) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Failed to make complete framebuffer object: %i"</span>, glCheckFramebufferStatus(GL_FRAMEBUFFER));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)tearDownBuffers&#123;</div><div class="line">    <span class="keyword">if</span> (_framebuffer) &#123;</div><div class="line">        <span class="comment">//delete framebuffer</span></div><div class="line">        glDeleteFramebuffers(<span class="number">1</span>, &amp;_framebuffer);</div><div class="line">        _framebuffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (_colorRenderbuffer) &#123;</div><div class="line">        <span class="comment">//delete color render buffer</span></div><div class="line">        glDeleteRenderbuffers(<span class="number">1</span>, &amp;_colorRenderbuffer);</div><div class="line">        _colorRenderbuffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)drawFrame &#123;</div><div class="line">    <span class="comment">//bind framebuffer &amp; set viewport</span></div><div class="line">    glBindFramebuffer(GL_FRAMEBUFFER, _framebuffer);</div><div class="line">    glViewport(<span class="number">0</span>, <span class="number">0</span>, _framebufferWidth, _framebufferHeight);</div><div class="line"></div><div class="line">    <span class="comment">//bind shader program</span></div><div class="line">    [<span class="keyword">self</span>.effect prepareToDraw];</div><div class="line"></div><div class="line">    <span class="comment">//clear the screen</span></div><div class="line">    glClear(GL_COLOR_BUFFER_BIT); glClearColor(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//set up vertices</span></div><div class="line">    GLfloat vertices[] = &#123;</div><div class="line">        <span class="number">-0.5</span>f, <span class="number">-0.5</span>f, <span class="number">-1.0</span>f, <span class="number">0.0</span>f, <span class="number">0.5</span>f, <span class="number">-1.0</span>f, <span class="number">0.5</span>f, <span class="number">-0.5</span>f, <span class="number">-1.0</span>f,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//set up colors</span></div><div class="line">    GLfloat colors[] = &#123;</div><div class="line">        <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f, <span class="number">1.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//draw triangle</span></div><div class="line">    glEnableVertexAttribArray(GLKVertexAttribPosition);</div><div class="line">    glEnableVertexAttribArray(GLKVertexAttribColor);</div><div class="line">    glVertexAttribPointer(GLKVertexAttribPosition, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, vertices);</div><div class="line">    glVertexAttribPointer(GLKVertexAttribColor,<span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, colors);</div><div class="line">    glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="comment">//present render buffer</span></div><div class="line">    glBindRenderbuffer(GL_RENDERBUFFER, _colorRenderbuffer);</div><div class="line">    [<span class="keyword">self</span>.glContext presentRenderbuffer:GL_RENDERBUFFER];</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)viewDidLoad&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">//set up context</span></div><div class="line">    <span class="keyword">self</span>.glContext = [[EAGLContext alloc] initWithAPI: kEAGLRenderingAPIOpenGLES2];</div><div class="line">    [EAGLContext setCurrentContext:<span class="keyword">self</span>.glContext];</div><div class="line"></div><div class="line">    <span class="comment">//set up layer</span></div><div class="line">    <span class="keyword">self</span>.glLayer = [<span class="built_in">CAEAGLLayer</span> layer];</div><div class="line">    <span class="keyword">self</span>.glLayer.frame = <span class="keyword">self</span>.glView.bounds;</div><div class="line">    [<span class="keyword">self</span>.glView.layer addSublayer:<span class="keyword">self</span>.glLayer];</div><div class="line">    <span class="keyword">self</span>.glLayer.drawableProperties = @&#123;kEAGLDrawablePropertyRetainedBacking:@NO, kEAGLDrawablePropertyColorFormat: kEAGLColorFormatRGBA8&#125;;</div><div class="line"></div><div class="line">    <span class="comment">//set up base effect</span></div><div class="line">    <span class="keyword">self</span>.effect = [[GLKBaseEffect alloc] init];</div><div class="line"></div><div class="line">    <span class="comment">//set up buffers</span></div><div class="line">    [<span class="keyword">self</span> setUpBuffers];</div><div class="line"></div><div class="line">    <span class="comment">//draw frame</span></div><div class="line">    [<span class="keyword">self</span> drawFrame];</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)viewDidUnload&#123;</div><div class="line">    [<span class="keyword">self</span> tearDownBuffers];</div><div class="line">    [<span class="keyword">super</span> viewDidUnload];</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)dealloc&#123;</div><div class="line">    [<span class="keyword">self</span> tearDownBuffers];</div><div class="line">    [EAGLContext setCurrentContext:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>运行代码查看效果 用OpenGL渲染的CAEAGLLayer图层</p>
<p>在一个真正的OpenGL应用中，我们可能会用NSTimer或CADisplayLink周期性地每秒钟调用-drawRrame方法60次，同时会将几何图形生成和绘制分开以便不会每次都重新生成三角形的顶点（这样也可以让我们绘制其他的一些东西而不是一个三角形而已），不过上面这个例子已经足够演示了绘图原则了。</p>
</div></div><div id="disqus_thread"><script>var disqus_shortname = 'zhuimar';
var disqus_identifier = '2014/10/19/2014/专用图层 - CAEAGLLayer/';
var disqus_title = '专用图层 - CAEAGLLayer';
var disqus_url = 'http://yoursite.com/2014/10/19/2014/专用图层 - CAEAGLLayer/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><!--script(id='dsq-count-scr', src='//#{theme.disqus}.disqus.com/count.js', async)--></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">zhuimar.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> Theme<a target="_blank" href="https://github.com/7ye/maupassant-hexo"> Maupassant.</a></div><a id="back_to_top" href="javascript:void(0)" class="back_to_top"><span>△</span></a><script type="text/javascript" src="/js/totop.js?v=0.0.1"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>function auto_code_fit(){
  if($(".highlight").length != 0){
    var pc_width = $(".post-content").width();
    $(".highlight .code").find("pre").width((pc_width-70)+"px");
  }
}
window.onresize = function(){
  auto_code_fit();
}
auto_code_fit();</script></div></body>